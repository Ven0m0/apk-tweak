name: Check for New Client Releases

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Run daily

jobs:
  check-client-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Initialize releases file
        run: touch all_releases.txt

      - name: Cache AAPT tool
        id: cache-aapt
        uses: actions/cache@v5
        with:
          path: build-tools
          key: aapt-r33.0.2

      - name: Download AAPT Tool
        if: steps.cache-aapt.outputs.cache-hit != 'true'
        run: |
          curl -sSL https://dl.google.com/android/repository/build-tools_r33.0.2-linux.zip -o build-tools.zip
          unzip -q build-tools.zip -d build-tools

      - name: Download Clients
        run: |
          # Download clients in parallel for faster execution
          curl -sSL -o telegram.apk https://telegram.org/dl/android/apk &
          PID_TG=$!
          wait $PID_TG

      - name: Download ForkGram Client
        uses: robinraju/release-downloader@v1
        with:
          fileName: "ForkClient*.apk"
          repository: forkgram/TelegramAndroid
          latest: true

      - name: Download TelegramFOSS Client
        uses: robinraju/release-downloader@v1
        with:
          fileName: "TF*.apk"
          repository: Telegram-FOSS-Team/Telegram-FOSS
          latest: true

      - name: Check for New Client Releases
        id: check-client-releases
        run: |
          set -euo pipefail
          shopt -s nullglob
          AAPT="build-tools/android-13/aapt"
          chmod +x "$AAPT"
          RELEASES_FOUND=false

          # Function to extract version from APK (reduces code duplication)
          get_apk_version() {
            local apk="$1"
            local info
            info=$("$AAPT" dump badging "$apk" 2>/dev/null | grep -E "versionName|versionCode" | head -1)
            local ver_name ver_code
            ver_name=$(echo "$info" | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
            ver_code=$(echo "$info" | sed -n "s/.*versionCode='\([^']*\)'.*/\1/p")
            echo "$ver_name $ver_code"
          }

          # Function to update release version (reduces code duplication)
          update_release() {
            local name="$1"
            local version="$2"
            if grep -q "^$name: " all_releases.txt; then
              local existing
              existing=$(grep "^$name: " all_releases.txt | cut -d ' ' -f 2-)
              if [ "$existing" != "$version" ]; then
                sed -i "s|^$name: .*|$name: $version|" all_releases.txt
                return 0  # Updated
              fi
              return 1  # No change
            else
              echo "$name: $version" >> all_releases.txt
              return 0  # Added new
            fi
          }

          echo "--- Checking Client Releases ---"

          # Process all clients using the helper functions
          for apk_pattern in "telegram*.apk:Telegram" "ForkClient*.apk:ForkGram" "TF*.apk:TelegramFOSS"; do
            pattern="${apk_pattern%%:*}"
            name="${apk_pattern##*:}"
            apk_files=($pattern)
            apk_file="${apk_files[0]:-}"
            if [[ -n "$apk_file" ]]; then
              version=$(get_apk_version "$apk_file")
              echo "Current $name Version: $version"
              if update_release "$name" "$version"; then
                RELEASES_FOUND=true
              fi
            fi
          done

          # Check for New Module Releases
          echo "--- Checking Module Releases ---"
          MODULE_REPOS="Xposed-Modules-Repo/com.my.televip araafroyall/Telegram-Speed-Hook JeelsBoobz/Killergram Xposed-Modules-Repo/com.alex193a.tguseridviewer JingMatrix/LSPatch"

          for REPO in $MODULE_REPOS; do
            # üõ°Ô∏è Sec: Add Auth Header to prevent rate limiting
            LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}")

            if [[ $LATEST_RELEASE == *"Bad credentials"* ]] || [[ $LATEST_RELEASE == *"message"* ]]; then
              echo "Error checking releases for $REPO"; continue
            fi
            TAG_NAME=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // empty')
            REPO_NAME="${REPO##*/}"
            if [ -n "$TAG_NAME" ]; then
              echo "Current $REPO_NAME Tag: $TAG_NAME"
              if update_release "$REPO_NAME" "$TAG_NAME"; then
                RELEASES_FOUND=true
              fi
            else
              echo "No releases found for $REPO"
            fi
          done

          if [ "$RELEASES_FOUND" = true ]; then
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action"
            git add all_releases.txt
            git commit -m "Update client and module versions in all_releases.txt"
            git push

            curl -sS -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/MartinatorTime/auto-lspatch/actions/workflows/build-telegram.yml/dispatches \
              -d '{"ref":"main"}' || true
          else
            echo "No changes to commit or trigger the workflow"
          fi
        shell: bash
